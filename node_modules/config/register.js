var crypto = require('crypto');
var rand = require('csprng');
var mongoose = require('mongoose'); 
var models = require('config/models');
var user = models.user;
var mailExist = require('email-existence');
var fs = require('file-system');

exports.register = function(email, username, password, gender,avatar,cover_image, callback){
	var x = email;
	var createProfileDefault = function(username){
		var profile = models["profile_" + username];
		var default_profile = new profile({
			username : username,
			gender : gender,
			age : 0,
			school_name : '',
			company_name : '',
			favorite : '',
			relationship_status : '',
			address : ''
		});
		default_profile.save();
	}
	if(x.indexOf("@") > -1){
		if(password.match(/([a-z].*[A-Z])|([A-Z].*[a-z])/) && password.length > 4 && password.match(/[0-9]/)){
			if(gender == "" || gender == null){
				callback({'response' : "Please verifies your Gender"});
			}else{
				mailExist.check(email, function(err, res){
					if(res == true){
						var tmp = rand(160, 36);
						var newpass = tmp + password;
						var token = crypto.createHash('sha512').update(email +rand).digest("hex");
						var hashed_password = crypto.createHash('sha512').update(newpass).digest("hex");
						var newuser = new user({    
							    token: token,   
							    email: email,
							    username : username,   
							    hashed_password: hashed_password,   
							    salt :tmp,
							    gender : gender,
							    avatar : avatar,
							    cover_image : cover_image 
							});
						if(user.collection.collection == null){
							newuser.save(function(err){
									models.createDefaultCollection(username);
									createProfileDefault(username);
									callback({'response':"Sucessfully Registered"});
								});
						}else{
							user.find({email : email}, function(err, users){
								var length = users.length;
								if(length == 0){
									newuser.save(function(err){
										models.createDefaultCollection(username);
										createProfileDefault(username);
										callback({'response':"Sucessfully Registered"});
									})
								}else{
									callback({'response':"Email already Registered"});
								}
							})
						}
					}else{
						callback({'response' : "Email Not Exists"});
					}
				})
			}
		}else{
			callback({'response':"Password Weak"});
		}
	}else{
		callback({'response':"Email Not Valid"});
	}
}
