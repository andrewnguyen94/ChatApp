var crypto = require('crypto');
var rand = require('csprng'); 
var mongoose = require('mongoose'); 
var gravatar = require('gravatar'); 
var models = require('config/models');
var user = models.user;

exports.login = function(username, password, callback){
	if(user.collection.collection == null){
		var username = 'andrewnguyen';
		var passAdmin = '28111994';
		var temp = rand(160,36);
		var email = 'andrewnguyen281194@gmail.com';
		var newpass = passAdmin + temp;
		var token = crypto.createHash('sha512').update(email +rand).digest("hex"); 
		var gender = 'man';
		var hashed_password_admin = crypto.createHash('sha512').update(newpass).digest("hex");  
		var admin = new user({
			token: token,
			email:email,
			username: username,
			hashed_password : hashed_password_admin,
			salt:temp,
			gender : gender
		});
		admin.save();
		callback({'response' : "User not exist", 'res' : false});
	}else{
		user.find({username : username}, function(err, users){
		if(users.length != 0){
			var email = users[0].email;
			var temp = users[0].salt;
			var hash_db = users[0].hashed_password;
			var id = users[0].token;
			var avatar_base64 = users[0].avatar;
			var cover_image_base64 = users[0].cover_image;
			var newpass = temp + password;
			var hashed_password = crypto.createHash('sha512').update(newpass).digest("hex");
			var grav_url = gravatar.url(email, {s: '200', r: 'pg', d: '404'});
			if(hash_db == hashed_password){
				callback({'response':"Login Sucess",'res':true,'token':id,'grav':grav_url,'avatar_base64': avatar_base64,'username':username,
					'cover_image_base64' : cover_image_base64});
			}else{
				callback({'response':"Invalid Password",'res':false});
			}
		}else{
			callback({'response':"User not exist",'res':false});
		}
	});
	}
}